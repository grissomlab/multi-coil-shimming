
MGH multi-coil shimming MATLAB simulation tools
Version 1.0
June, 2016

Requirements: This MATLAB script requires the Optimization Toolbox (fmincon) and the Global Optimization Toolbox (ga).  The code also optionally uses FSL to perform brain masking (BET) and phase unwrapping (PRELUDE), but this can be bypassed if user-supplied B0 field maps are already masked and phase unwrapped.

Make sure all provided subfolders are included in the MATLAB file path.  

Questions, comments, bug reports, and suggestions are welcome.  Please contact:

Jason Stockmann
Massachusetts General Hospital
jaystock@nmr.mgh.harvard.edu

Disclaimer:  The author and Massachusetts General Hospital are not liable
for any damages that occur in connection with using, modifying, or 
distributing this software.  The software is not intended for diagnostic
purposes.


This set of simulations tools includes the following features:

====================================================================
(1.) Biot-Savart calculator to compute B0 vector fields generated by various "helmet_style" geometries of shim loops ranging from 8 channels to 128 channels. Most of the geometries consist of coils patterned on close-fitting helmet substrates in configurations often used for RF coil arrays tailored for brain imaging.  The 48ch cylindrical multi-coil shim array described in Juchem C. et al., JMR 2011 is also included for comparison.  

The longitudinal fields (b1_z) are calculated in units of Tesla and are converted into Hz using the proton gyromagnetic ratio (42.57e6 Hz/T) in the shimming wrapper script.

The coil field maps for each array are stored in the folder named for the array size, for example the 32ch helmet array:

./coil_field_maps/generate_coil_field_maps/32ch/b1_32ch_save.mat

The geometry is specified in the file:

array_circle32.txt

where the odd lines of text specify each loop's center in x, y, and z and the even lines specify the normal vector for each loop face.

The loops are approximated as flat circles (no curvature on loop surface).  

To recalculate the coil field components, run the script:

b1sim_dc_array_circle32.m

====================================================================

(2.) Multi-coil shimming simulations for the above coil geometries based on in vivo B0 field maps that have already been shimmed up to 2nd order.  Run the following script:

loop_shim_optimization_wrapper_code_V1.m

Specify the coil array to use in the optimization using this string:

coil_field_map_file = 'hybrid_rf_shim_coil_faceloops_39ch.mat'
 

Six example in vivo B0 field maps acquired at 3 Tesla (shimmed up to 2nd order) are specified in the field shim.subj

The genetic algorithm routine converges toward the optimal subarray of a desired size for one of the fully-populated coil geometries specified by the coil_field_map_file. 

The following script is used by the genetic algorithm:

shim_optimization_objective_function_ga_V1.m

Inside this script the user can optionally include 0th to 2nd order spherical harmonics in the shimming basis set along with the loop coil profiles.  

The genetic algorithm runs indefinitely and should be terminated manually when the Fitness Function stops changing in the plot.  The optimizer script saves the results of each iteration of the genetic algorithm, so the saved results will specify the coils used in the optimal subarray for the previous iteration.  

The optimal shim currents are calculated for each candidate sub-array using the script:

perform_shim_V1.m

with the root mean square cost function specified in:

shim_fun_V1.m

Alternatively, the standard deviation of the shimmed B0 field maps can be penalized by substituting this alternative cost function:

shim_fun_std_V1.m

But in practice the two cost functions give comparable results.  



====================================================================



When using any of this code, please cite Fa-Hsuan Lin's Biot-Savart solver tool:

Fa-Hsuan Lin, "Magnetic field by Biot-Savart's Law"
http://maki.bme.ntu.edu.tw/?page_id=333


For the loop optimization using the genetic algorithm, please cite the following ISMRM abstract:

Stockmann JP, Guerin B, Wald LL.  "Improving the efficiency of integrated RF-shim arrays using hybrid coil designs and channel placement and compression via a genetic algorithm", Proc. of Int. Soc. Magn. Res. Med., 2016, p. 1153.

===================================================================




